<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.library.mapper.RentMapper">

    <!-- id는 @Mapper에서 정의한 이름과 동일해야 함 parameterType은 참고 할 자료를 넣음-->

    <!-- 대여 (정보 저장) -->
    <insert id="saveRent" parameterType="com.project.library.dto.request.RentRequest"
    useGeneratedKeys="true" keyProperty="id">
        INSERT INTO rent (
            rentDate, expactedReturnDate, memberId, bookId
        ) VALUES (
            NOW(),
            DATE_ADD(NOW(), INTERVAL 14 DAY),
            #{memberId},
            #{bookId}
        )
    </insert>

    <!-- 대여 정보 PK로 받아오기 -->
    <select id="findById" resultType="com.project.library.dto.response.RentResponse">
        SELECT
            r.id, r.rentDate, r.expactedReturnDate, r.returnDate, r.memberId, b.title, b.status
        FROM
            rent as r
        INNER JOIN
            book as b
        ON
            r.bookId = b.id
        WHERE
            r.id = #{id}
    </select>

    <!-- 대여버튼을 누름과 동시에 book.status값 대여불가 -->
    <update id="updateBookStatusFalse" parameterType="com.project.library.dto.request.RentRequest">
        UPDATE
            rent as r
        INNER JOIN
            book as b
        ON
            r.bookId = b.id
        SET
            b.status = '대여불가'
        WHERE
            r.bookId = #{bookId} AND b.status = '대여가능'
    </update>

    <!--반납버튼을 누름과 동시에 book.status값 대여가능-->
    <update id="updateBookStatusTrue" parameterType="com.project.library.dto.request.RentRequest">
        UPDATE
            rent as r
        INNER JOIN
            book as b
        ON
            r.bookId = b.id
        SET
            b.status = '대여가능'
        WHERE
            r.id = #{id} AND b.status = '대여불가'
    </update>

    <!-- 반납 했을시 시간 변경-->
    <update id="updateReturn" parameterType="long">
        UPDATE
            rent
        SET
            returnDate = NOW()
        WHERE
            id = #{id}
    </update>




</mapper>

